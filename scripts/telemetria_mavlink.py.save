#!/usr/bin/env python3
import logging
import time
from pymavlink import mavutil
import math
from storage.db import (
    get_db_connection,
    init_db,
    insert_gps,
    insert_attitude,
    insert_imu,
)

# ----------------------------------------------------------
# CONFIGURACIÓN
# ----------------------------------------------------------

DEVICE = "/dev/ttyACM0"   # USB Pixhawk
BAUD   = 57600
SAVE_INTERVAL = 1.0  # segundos
last_db_save = 0.0

logging.basicConfig(
    level=logging.INFO,
    format="%(asctime)s [TEL] %(message)s"
)

# ----------------------------------------------------------
# VARIABLES DE ESTADO PARA IMPRESIÓN CADA 5 s
# ----------------------------------------------------------

last_status = {
    "lat": None,
    "lon": None,
    "alt": None,
    "groundspeed": None,
    "heading": None,
    "roll": None,
    "pitch": None,
    "yaw": None,
}

last_print_time = 0.0
PRINT_INTERVAL = 5.0


def print_status():
    """Imprime telemetría resumida cada 5 s."""
    lat = last_status["lat"]
    lon = last_status["lon"]
    alt = last_status["alt"]
    gs  = last_status["groundspeed"]
    hdg = last_status["heading"]
    roll = last_status["roll"]
    pitch = last_status["pitch"]
    yaw = last_status["yaw"]

    partes = []

    if lat is not None and lon is not None:
        if alt is not None:
            partes.append(f"GPS lat={lat:.6f}, lon={lon:.6f}, alt={alt:.1f} m")
        else:
            partes.append(f"GPS lat={lat:.6f}, lon={lon:.6f}")

    if gs is not None or hdg is not None:
        s = []
        if gs is not None: s.append(f"SOG={gs:.2f} kn")
        if hdg is not None: s.append(f"COG={hdg:.1f}°")
        if s: partes.append(" ".join(s))

    if roll is not None or pitch is not None or yaw is not None:
        partes.append(
            "ATT roll={:.1f}° pitch={:.1f}° yaw={:.1f}°".format(
                roll if roll is not None else 0,
                pitch if pitch is not None else 0,
                yaw if yaw is not None else 0
            )
        )

    if partes:
        logging.info(" | ".join(partes))
    else:
        logging.info("Aún no hay suficientes datos.")


# ----------------------------------------------------------
# PROCESO PRINCIPAL
# ----------------------------------------------------------

def main():

    global last_print_time

    logging.info("Iniciando módulo MAVLink (USB).")

    conn = get_db_connection()
    init_db(conn)

    # Conectar a Pixhawk por USB
    try:
        master = mavutil.mavlink_connection(DEVICE, baud=BAUD)
        logging.info(f"MAVLink conectado en {DEVICE} @ {BAUD}")
    except Exception as e:
        logging.error(f"Error abriendo {DEVICE}: {e}")
        return

    logging.info("Esperando heartbeat...")
    try:
        master.wait_heartbeat(timeout=20)
    except:
        logging.error("No llegó el heartbeat de la Pixhawk.")
        return

    logging.info("Heartbeat recibido. Comenzando lectura MAVLink...")

    while True:
        try:
            msg = master.recv_match(blocking=False)
            now = time.time()

            if msg is None:
                # ¿Toca imprimir?
                if now - last_print_time >= PRINT_INTERVAL:
                    print_status()
                    last_print_time = now
                time.sleep(0.05)
                continue

            mtype = msg.get_type()

            # --------------------------------------------------
            # GLOBAL_POSITION_INT   (LAT/LON/ALT + ground speed)
            # --------------------------------------------------
            if mtype == "GLOBAL_POSITION_INT":
                lat = msg.lat / 1e7
                lon = msg.lon / 1e7
                alt = msg.alt / 1000.0

                groundspeed = None
                try:
                    groundspeed = msg.vx / 100.0 * 1.94384
                except:
                    pass

                heading = None
                try:
                    heading = msg.hdg / 100.0
                except:
                    pass

                # Guardar estado
                last_status["lat"] = lat
                last_status["lon"] = lon
                last_status["alt"] = alt
                last_status["groundspeed"] = groundspeed
                last_status["heading"] = heading

                # Guardar en BD
                insert_gps(conn, time.time(), lat, lon, alt, groundspeed, heading)

            # -----------------------------
            # ATTITUDE (roll/pitch/yaw)
            # -----------------------------
            elif mtype == "ATTITUDE":
                roll = msg.roll * 180 / math.pi
                pitch = msg.pitch * 180 / math.pi
                yaw = msg.yaw * 180 / math.pi

                last_status["roll"] = roll
                last_status["pitch"] = pitch
                last_status["yaw"] = yaw

                insert_attitude(conn, time.time(), roll, pitch, yaw)


            # ------------------------------------------------
            # ¿Toca imprimir resumen?
            # ------------------------------------------------
            if now - last_print_time >= PRINT_INTERVAL:
                print_status()
                last_print_time = now

        except KeyboardInterrupt:
            logging.info("Saliendo por Ctrl+C")
            break

        except Exception as e:
            logging.error(f"Error procesando mensaje: {e}")
            time.sleep(0.1)

    conn.close()
    logging.info("Conexión BD cerrada.")


if __name__ == "__main__":
    main()
